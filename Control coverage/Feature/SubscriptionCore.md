## SubscriptionCore

| ControlId | Dependent Azure API(s) and Properties | Control spec |
|-----------|---------------------------------------|------------------|
| <b>ControlId:</b><br>Azure_Subscription_Config_ASC_Enable_AutoProvisioning<br><br><b>DisplayName:</b><br>Turn on Microsoft Monitoring Agent (MMA) to enable Security Monitoring.<br><br><b>Description: </b><br>Auto Provisioning must be set to ON in Azure Security Center. | <b>ARM API to list auto provisioning settings at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/autoProvisioningSettings<br>/default<br>?api-version=2017-08-01-preview<br><b>Property:</b><br>autoProvision | <b>Scope: </b> Subscription<br><br><b>Config: </b> NA<br><br> <b>Passed: </b><br>Auto Provisioning is enabled.<br><br> <b>Failed: </b><br>Auto Provisioning is not enabled or if security center provider is not registered.<br><b>Verify: </b><br>Unable to verify Auto Provisioning detail. |
| <b>ControlId:</b><br>Azure_Subscription_Config_ASC_Tier<br><br><b>DisplayName:</b><br>Enable all Azure Defender plans in Azure Security Center.<br><br><b>Description: </b><br>Standard tier must be enabled for Azure Security Center. | <b>ARM API to list Security Center pricing <br>configurations in the subscription:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/pricings<br>?api-version=2018-06-01<br><b>Properties:</b><br>pricingTier, name | <b>Scope: </b> Subscription<br><br><b>Config: </b> ReqASCTier:  Standard <br> ReqASCTierResourceTypes: "VirtualMachines, SqlServers, AppServices, StorageAccounts, KubernetesService, ContainerRegistry, KeyVaults, SqlServerVirtualMachines" <br><br> <b>Passed: </b><br>All required resource types are configured with ASC standard tier.<br><br> <b>Failed: </b><br>Any of resource types is not configured with ASC standard tier or if security center provider is not registered. |
| <b>ControlId:</b><br>Azure_Subscription_AuthZ_Dont_Use_NonAD_Identities<br><br><b>DisplayName:</b><br>Remove external accounts from Azure subscriptions<br><br><b>Description: </b><br>Do not grant permissions to external accounts (i.e., accounts outside the native directory for the subscription). | <b>PIM API to get role assignments:</b><br> /beta/privilegedAccess/azureResources<br>/resources/{uniquePIMIdentifier}/roleAssignments<br>?$expand=subject,roleDefinition<br>($expand=resource)&$filter=(memberType<br>%20ne%20'{filterCondition}')<br><b>Property:</b><br>subject/principalName<br><br><b>ARM API to list classic role assignment at <br>subscription level:</b><br>subscriptions/{subscriptionId}/providers<br>/Microsoft.Authorization/classicAdministrators<br>?api-version=2015-06-01<br><b>Property:</b><br> emailAddress | <b>Scope: </b> Applies to subscription persistent roles, classic/servcie admins and PIM assignment for Azure resources.<br><br><b>Config: </b> NA<br><br> <b>Passed: </b><br>No external account is found at subscription scope.<br><br> <b>Failed: </b><br>External account is found at subscription scope.<br><b>Verify: </b><br>RBAC result not found (sufficient data is not available for evaluation). |
| <b>ControlId:</b><br>Azure_Subscription_AuthZ_Remove_Deprecated_Accounts<br><br><b>DisplayName:</b><br>Remove deprecated accounts from your subscription(s).<br><br><b>Description: </b><br>Deprecated/stale accounts must not be present on the subscription. | <b>ARM API to list role assignment at scope:</b> <br>/{scope}/providers/Microsoft.Authorization/roleAssignments<br>?api-version=2018-01-01-preview<br><b>Property:</b> principalId<br><br><b>PIM API to get role assignment:</b><br> /beta/privilegedAccess/azureResources<br>/resources/{uniquePIMIdentifier}/roleAssignments<br>?$expand=subject,roleDefinition<br>($expand=resource)&$filter=<br>(memberType%20ne%20'{filterCondition}')<br><b>Property:</b><br> subject/id<br><br><b>ARM API to list security assessments at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments<br>?api-version=2020-01-01<br><b>Properties:</b><br>id, name, resourceDetails/Id, displayName, status/code,<br> status, additionalData| <b>Scope: </b> Subscription scope only. Currently Resource Group and Resource RBAC we are currently not checking for these deprecated accounts.<br><br><b>Config: </b> DeprecatedAccounts : "" (Comma separated list of object id)<br><br> <b>Passed: </b><br>No deprecated account is found at subscription scope (in both ASC and Reader scan).<br><br> <b>Failed: </b><br>Deprecated account is found at subscription scope (in any one of ASC and Reader scan).<br><b>Verify: </b><br>ASC assessment status is not applicable or policy is missing. |
| <b>ControlId:</b><br> Azure_Subscription_Audit_Resolve_Azure_Security_Center_Alerts <br><br><b>DisplayName:</b><br> Pending Azure Security Center (ASC) alerts must be resolved. <br><br><b>Description: </b><br> Pending Azure Security Center (ASC) alerts must be resolved. | <b> ARM API to list all the alerts that are associated with<br> the subscription: </b> <br> /subscriptions/{subscriptionId}/providers/microsoft.Security<br>/alerts?api-version=2015-06-01-preview <br><b>Properties:</b><br> properties.state, properties.reportedSeverity,<br> properties.reportedTimeUtc | <b>Scope: </b> Subscription<br><br><b>Config: </b> ASCAlertsGraceInDays <br> a. "High": 0 <br> b. "Medium": 30<br><br> <b>Passed: </b><br> a. There are no active ASC Alerts. <br> b. There is no active alert which is beyond defined grace. <br><br> <b>Failed: </b><br> There are ASC alerts in the subscription which are active beyond the defined grace. <i> <br><br> - Alert Severity: High <br> - Grace period: 0 <br><br> - Alert Severity: Medium<br> - Grace period: 30 </i>|
| <b>ControlId:</b><br>Azure_Subscription_Config_ASC_Setup_SecurityContacts<br><br><b>DisplayName:</b><br>A security contact and alerts must be configured for your subscription. <br><br><b>Description: </b><br> Security contact details must be configured in Azure Security Center. | <b> ARM API to list all security contact configurations for the<br> subscription: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Security<br>/securityContacts?api-version=2020-01-01-preview <br><b>Properties:</b><br> properties.emails <br> properties.phone <br> properties.alertNotifications.state <br> properties.alertNotifications.minimalSeverity <br> properties.notificationsByRole.state <br> properties.notificationsByRole.roles | <b>Scope: </b> Subscription <br><br><b>Config: </b> "SecurityContacts": { "AlertNotificationState": "On", <br> "AlertNotificationSeverities": [ "Medium", "Low" ], <br> "NotificationsRecipientsState": "On", <br> "NotificationsRecipientsRoleName": [ "Owner", "ServiceAdmin" ] }<br><br> <b>Passed: </b><br>ASC security contact setting meet the following conditions: <br> &nbsp; 1.a. 'Owner' and 'Account Admin' should be selected as email recipients. <br>   &nbsp; 1.b. At least one email id is specified as email recipients. <br>   &nbsp; 1.c. Alert notification should be enabled.  <br>   &nbsp; 1.d. Alert notification severity should be at least set to 'Medium' such that notification is triggered for both Medium and High severity alert. <br><br> <b>Failed: </b><br> 1. ASC security contact setting does not meet the following conditions: <br>     &nbsp; 1.a. 'Owner' and 'Account Admin' should be selected as email recipients. <br>     &nbsp; 1.b. At least one email id is specified as email recipients. <br>     &nbsp; 1.c. Notify about alerts is enabled. <br>     &nbsp; 1.d. Alert notification severity should be at least set to 'Medium' such that notification is triggered for both Medium and High severity alert. <br> 2. Fail if security center provider is not registered. |
| <b>ControlId:</b><br>Azure_Subscription_AuthZ_Limit_ClassicAdmin_Count<br><br><b>DisplayName:</b><br>There should not be more than 2 classic administrators.<br><br><b>Description: </b><br>There should not be more than 2 classic administrators. | <b>ARM API to list classic admins at subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Authorization/classicAdministrators<br>?api-version=2015-06-01<br><b>Property:</b><br>RoleDefinitionName, Scope, SignInName | <b>Scope: </b> Subscription<br><br><b>Config: </b> NoOfClassicAdminsLimit : 2<br><br> <b>Passed: </b><br>The count of classic administrators does not exceed 2.<br><br> <b>Failed: </b><br> More than 2 classic administrator accounts found.|
| <b>ControlId:</b><br>Azure_Subscription_AuthZ_Remove_Management_Certs<br><br><b>DisplayName:</b><br>Use of management certificate is not permitted.<br><br><b>Description: </b><br>Management certificates are classic methods for automation on Azure subscription but are risky because the hygiene tends to be laxed and can easily be compromised. | <b>ARM API to list security assessments at subscription<br> level:</b><br>/subscriptions/{subscriptionId}/providers/Microsoft.Security<br>/assessments?api-version=2020-01-01<br><b>Properties:</b><br>id, name, resourceDetails/Id, displayName, status/code,<br> status, additionalData | <b>Scope: </b> Subscription<br><br><b>Config: </b>AssessmentName: 2acd365d-e8b5-4094-bce4-244b7c51d67c<br><br> <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><br> <b>Failed: </b><br>ASC assessment found with Unhealthy status code. |
| <b>ControlId:</b><br>Azure_Subscription_AuthZ_Dont_Grant_Persistent_Access<br><br><b>DisplayName:</b><br>Permanent access should not be granted for privileged subscription level roles.<br><br><b>Description: </b><br>Permanent access should not be granted for privileged subscription level roles. | <b>Azure Graph API to fetch PIM resource id for a specified<br> scope:</b><br>https://graph.microsoft.com/beta/privilegedAccess/azureResources/resources?     <br><b>Properties:</b><br>Id <br><br> <b>Azure Graph API to fetch PIM and permanent role assignment for a specified scope:</b><br>https://graph.microsoft.com/beta/privilegedAccess/azureResources//resources/{Id}/roleAssignments?<br><b>Properties:</b><br>externalId, roleDefinition.resource.registeredRoot, roleDefinition.resource.externalId, subject.type, assignmentState, linkedEligibleRoleAssignmentId, memberType, roleDefinition.displayName, subject.displayName  <br><br> <b>Azure AD Graph API V1.0 to fetch object ids of user, groups and app details from Azure Active Directory:</b><br>https://graph.windows.net/myorganization/getObjectsByObjectIds<br>?api-version=1.6 <br><b>Properties:</b><br>objectType, objectId, displayName, userPrincipalName <br><br> <b>Azure AD Graph API V1.0 to fetch user, groups and app details from Azure Active Directory:</b><br>https://graph.windows.net/myorganization/users<br>?api-version=1.6 <br><b>Properties:</b><br>objectType, objectId, displayName<br><br> <b>ARM API to fetch permanent role assignment at all scope in a subscription:</b><br>https://management.azure.com/providers/Microsoft.Authorization/roleAssignments<br>?api-version=2018-01-01-preview<br><b>Properties:</b><br>properties.scope, properties.principalType, properties.roleDefinitionId| <b>Scope: </b>  Subscription (User and Group Accounts Only; Excluding inherited role assignment)<br><br><b>Config: </b>CriticalPIMRoles : Owner (8e3af657-a8ff-443c-a75c-2fe8c4bcb635), Contributor (b24988ac-6180-42a0-ab88-20f7382dd24c), User Access Administrator (18d7d88d-d35e-4fb5-a5c3-7773c20a72d9)<br> AllowedIdentityDisplayNames: MS-PIM<br> ExemptedPIMGroupsPattern: JIT_(.)*_ElevatedAccess<br><br> <b>Passed: </b><br>a. No critical permanent role (Owner, Contributor, UAA) assignments present at subscription level<br> *or* <br>No role assignment present in subscription<br><br> <b>Failed: </b><br>Any critical permanent role (Owner, Contributor, UAA) assignments are present at subscription level. <br><br> <b>Verify: </b><br>RBAC data was not found for a subscription in a day due to API failure.|
| <b>ControlId:</b><br>Azure_Subscription_AuthZ_Dont_Grant_Persistent_Access_RG<br><br><b>DisplayName:</b><br>Permanent access should not be granted for privileged roles at resource group level.<br><br><b>Description: </b><br>Permanent access should not be granted for privileged roles at resource group level. | <b>Azure Graph API to fetch PIM resource id for a specified scope:</b><br> https://graph.microsoft.com/beta/privilegedAccess/azureResources/resources? <br><b>Properties:</b><br>Id <br><br> <b>Azure Graph API to fetch PIM and permanent role assignment for a specified scope:</b><br> https://graph.microsoft.com/beta/privilegedAccess/azureResources//resources/{Id}/roleAssignments? <br><b>Properties:</b><br> externalId, roleDefinition.resource.registeredRoot, roleDefinition.resource.externalId, subject.type, assignmentState, linkedEligibleRoleAssignmentId, memberType, roleDefinition.displayName, subject.displayName<br><br> <b>Azure AD Graph API V1.0 to fetch user, groups and app details from Azure Active Directory:</b><br> https://graph.windows.net/myorganization/getObjectsByObjectIds<br>?api-version=1.6<br><b> Properties:</b><br> objectType, objectId, displayName, userPrincipalName<br><br> <b>Azure AD Graph API V1.0 to fetch user, groups and app details from Azure Active Directory:</b><br> https://graph.windows.net/myorganization/users<br>?api-version=1.6<br><b> Properties:</b><br> objectType, objectId, displayName<br><br> <b>ARM API to fetch permanent role assignment at all scope in a subscription:</b><br> https://management.azure.com/providers/Microsoft.Authorization/roleAssignments<br>?api-version=2018-01-01-preview<br><b> Properties:</b><br> properties.scope, properties.principalType, properties.roleDefinitionId | <b>Scope: </b> All resource groups in a subscription (User and Group Accounts Only; Excluding inherited role assignment).<br><br><b>Config: </b> CriticalPIMRoles : Owner (8e3af657-a8ff-443c-a75c-2fe8c4bcb635), User Access Administrator (18d7d88d-d35e-4fb5-a5c3-7773c20a72d9) <br>AllowedIdentityDisplayNames: MS-PIM<br> ExemptedPIMGroupsPattern: JIT_(.)*_ElevatedAccess<br><br> <b>Passed: </b><br>a. No critical permanent role (Owner, Contributor, UAA) assignments present at resource group level.<br> *or* <br>No role assignment present at resource group level.<br><br> <b>Failed: </b><br>Any critical permanent role (Owner, Contributor, UAA) assignments are present at resource group level. <br><br> <b>Verify: </b><br>RBAC data was not found for a subscription in a day due to API failure.|
| <b>ControlId:</b><br>Azure_Subscription_Configure_Conditional_Access_for_PIM<br><br><b>DisplayName:</b><br>Conditional Access policies required for Privileged Identity Management (PIM) roles by your org must be configured in your subscription.<br><br><b>Description: </b><br>Conditional Access policies required for Privileged Identity Management (PIM) roles by your org must be configured in your subscription. | <b>API to get unique PIM Identifier:</b><br> /beta/privilegedAccess/azureResources/resources?$filter=(tolower(externalId)%20eq%20%27{scopeId}%27)&$orderby=type<br><br> <b>API to get role setting using unique PIM identifier:</b><br> /beta/privilegedAccess/azureResources/roleSettings?$expand=resource,roleDefinition($expand=resource)&$filter=(resource/id+eq+%27{uniquePimIdentifier}%27)+and+((roleDefinition/templateId+eq+%27{ownerTemplateId}%27)+or+(roleDefinition/templateId+eq+%27{userAccessAdminTemplateId}%27)+or+(roleDefinition/templateId+eq+%27{contributorTemplateId}%27)) <br><b>Properties:</b> <br> userMemberSettings, DisplayName | <b>Scope: </b> Subscriptions <br><br><b>Config: </b> RuleName: xxx,<br>RuleSettings:<br>xxx <br><br> <b>Passed: </b><br>CA is enabled with correct policy.<br><br> <b>Failed: </b> <br> a. CA is disabled. <br>*or*<br> b. CA is configured with incorrect policy.|
| <b>ControlId:</b><br>Azure_Subscription_SI_Classic_Resources<br><br><b>DisplayName:</b><br>Classic resources must be migrated to new Azure Resource Manager resources.<br><br><b>Description: </b><br>Do not use any classic resources on a subscription. | <b>API to list all the resources in a subscription:</b><br> subscriptions/{subscriptionId}/resources?$expand=provisioningState,createdTime,changedTime&api-version=2018-05-01 <br><b>Properties:</b> <br> type | <b>Scope: </b> Subscriptions <br><br><b>Config: <br>*ClassicResourceTypes* <br>"Microsoft.ClassicCompute/virtualMachines"<br> "Microsoft.ClassicStorage/storageAccounts"<br> "Microsoft.ClassicCompute/domainNames"<br> "Microsoft.ClassicNetwork/virtualNetworks"<br><br> <b>Passed: </b><br>No classic resources found.<br><br> <b>Failed: </b> <br> Any classic resource found.|
| <b>ControlId:</b><br>Azure_Subscription_Use_Only_Alt_Credentials<br><br><b>DisplayName:</b><br>Ensure that critical operations in the subscription are conducted using alternate (ALT) credentials.<br><br><b>Description: </b><br>Ensure that critical operations in the subscription are conducted using alternate (ALT) credentials. | <b>Graph API to retrieve a collection of governanceResource<br> that the requestor has access to:</b><br>/privilegedAccess/azureResources/resources{*?query-parameters}<br> <b>Properties:</b><br> properties.id, properties.externalId, properties.status, properties.type<br><br> <b>Graph API to retrieve a collection of governanceRoleAssignments:</b><br>/resources/{uniquePIMIdentifier}/roleAssignments?$expand=subject,<br>roleDefinition($expand=resource)&$filter=(memberType%20ne%20'{filter}')<br><b> Properties:</b><br>externalId, roleDefinition.displayName, roleDefinition.resource.registeredRoot,<br> roleDefinition.resource.externalId, subject.type<br><br> <b>ARM API to get all role assignments for the subscription:</b><br>/{scopeId}/providers/Microsoft.Authorization/roleAssignments<br>?api-version=2018-01-01-preview<br><b>Properties:</b><br>properties.principalType, properties.roleDefinitionId, properties.scope<br><br> <b>ARM API to get service administrator, account administrator,<br> and co-administrators for the subscription:</b><br>/subscriptions/{subscriptionId}/providers/Microsoft.Authorization<br>/classicAdministrators?api-version=2015-06-01<br><b>Properties:</b><br>properties.role<br><br> <b>Graph API to return the directory objects specified in a list of IDs:</b><br>/beta/directoryObjects/getByIds?$select=id,userPrincipalName,onPremisesExtensionAttributes,<br>userType,creationType,externalUserState<br><b>Properties:</b><br>onPremisesExtensionAttributes.extensionAttribute2<br><br> <b>Azure AD Graph API to get a collection of users:</b><br>/myorganization/users?api-version=1.6&$filter=(userPrincipalName+eq+'{0}')<br>+or+(mail+eq+'{1}')&$select=objectType,<br>objectId,displayName,userPrincipalName<br><br><b>Azure AD Graph API to get objects from a list of object IDs:</b><br>  /myorganization/getObjectsByObjectIds?api-version=1.6&$select=objectType,objectId,displayName,userPrincipalName| <b>Scope: </b> All subscriptions and resource groups.<br><br><b>Config: </b> CriticalPIMRoles:<br>Subscription: [ "Owner", "Contributor", "User Access Administrator" ]<br>ResourceGroup: [ "Owner", "User Access Administrator" ]<br><br> <b>Passed: </b><br>No assignments for critical roles found at subscription and resource group level.<br><br> <b>Failed: </b><br>Non-Alt *user* account has been granted critical roles (as specified in the config above) at subscription and resource group scope.<br><br>*Note: Currently, 'Groups' that have been assigned critical roles at subscription or RG scope is out of scope of this controls. Therefore, this needs to be validated manually that any groups with critical role assignment should not have non-Alt accounts as group members.* |





