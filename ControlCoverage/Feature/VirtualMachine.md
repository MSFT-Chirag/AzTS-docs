## Virtual Machine

| ControlId | Dependent Azure API(s) and Properties | Control spec |
|-----------|---------------------------------------|------------------|
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Enable_Vuln_Solution<br><br><b>DisplayName:</b><br>Install DSRE Qualys Cloud Agent on assets.<br><br><b>Description:</b><br>Vulnerability assessment solution should be installed on VM. | <b>ARM API to list Virtual Machine Extensions at <br>resource level:</b><br>/subscriptions/{subscriptionId}/resourceGroups/<br>{resourceGroupName}/providers/Microsoft.<br>Compute/virtualMachines/{vmName}<br>/extensions<br>?api-version=2019-07-01<br><br><b>Properties:</b><br>publisher, type<br>| <b>Scope: </b> <br><br><b>Config: </b> <br><br> <b>Passed: </b><br>Required vulnerability assessment solution is present in VM.<br><br> <b>Failed: </b><br>Required vulnerability assessment solution is not present in VM.<br><br><b>NotApplicable: </b><br>VM instance is part of AKS or ADB cluster.<br><b>Not Scanned: </b><br>VM OS type is null or empty. |
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Enable_Monitoring_Agent<br><br><b>DisplayName:</b><br>All VMs must have Monitoring Agent enabled.<br><br><b>Description:</b><br>All VMs must have Monitoring Agent enabled. | <b>ARM API to list Virtual Machine Extensions at <br>resource level:</b><br>/subscriptions/{subscriptionId}/resourceGroups/<br>{resourceGroupName}/providers/Microsoft.<br>Compute/virtualMachines/{vmName}<br>/extensions<br>?api-version=2019-07-01<br><br><b>Properties:</b><br>publisher, type| <b>Scope: </b> Applies to all Azure Virtual Machine.<br><br><b>Config: </b> ExtensionsForWindows: <br>ExtensionType: IaaSDiagnostics, <br>Publisher: Microsoft.Azure.Diagnostics <br>ExtensionType: MicrosoftMonitoringAgent, <br>Publisher: Microsoft.EnterpriseCloud.Monitoring <br>ExtensionsForLinux: <br>ExtensionType: LinuxDiagnostic, <br>Publisher: Microsoft.Azure.Diagnostics <br>ExtensionType: OmsAgentForLinux, <br>Publisher: Microsoft.EnterpriseCloud.Monitoring <br>ExclusionTags <br>Desciption: VM is part of ADB cluster., <br>TagName: vendor, <br>TagValue: Databricks<br><br> <b>Passed: </b><br>All required extensions are present in VM<br><br> <b>Failed: </b><br>One or more required extensions are missing in VM.<br><br><b>NotApplicable: </b><br>VM is part of ADB cluster.<br><b>Not Scanned: </b><br>VM OS type is null or empty. |
| <b>ControlId:</b><br>Azure_VirtualMachine_NetSec_Apply_ASC_Network_Recommendations<br><br><b>DisplayName:</b><br>Apply Adaptive Network Hardening to your virtual machines.<br><br><b>Description:</b><br>Adaptive Network Hardening recommendations <br>should be applied on internet facing virtual machines. | <b>ARM API to list security assessments at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments?<br>api-version=2020-01-01<br><br><b>Properties:</b><br>id, name, resourceDetails/Id, displayName, status/code, status, additionalData | <b>Scope: </b> Windows and Linux VMs.<br><br><b>Config: </b> NA<br><br> <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><br> <b>Failed: </b><br>ASC assessment found with Unhealthy status code.|
| <b>ControlId:</b><br>Azure_VirtualMachine_Config_Enable_NSG<br><br><b>DisplayName:</b><br>Secure internet-facing virtual machines.<br><br><b>Description:</b><br>NSG must be configured for Virtual Machine. | <b>ARM API to list Network Interfaces at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkInterfaces<br><br>?api-version=2019-04-01<br><b>Property:</b><br>publicIPAddress/id, networkSecurityGroup/id<br><br><b>ARM API to list Virtual Networks at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/virtualNetworks<br><br>?api-version=2019-11-01<br><b>Property:</b><br>networkSecurityGroup/id<br>| <b>Scope: </b> Windows and Linux VMs; Except ADB VMs and ER-connected VMs.<br><br><b>Config: </b> NA<br><br> <b>Passed: </b><br>NSG is configured for the VM or VM does not have any public IP configured.<br><br> <b>Failed: </b><br>No NSG found on the VM.<br><br><b>NotApplicable: </b><br>VM instance is part of ADB cluster.|
| <b>ControlId:</b><br>\<br><br><b>DisplayName:</b><br>Secure internet-facing virtual machines.<br><br><b>Description:</b><br>Do not leave restricted ports open on Virtual Machines. | <b>ARM API to list Network Interfaces at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkInterfaces<br><br>?api-version=2019-04-01<br><b>Property:</b><br>networkSecurityGroup/id<br><br><b>ARM API to list Virtual Networks at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/virtualNetworks<br><br>?api-version=2019-11-01<br><b>Property:</b><br>networkSecurityGroup/id<br><br><b>ARM API to list Network Security Groups at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkSecurityGroups<br><br>?api-version=2019-04-01<br><b>Property:</b><br>destinationPortRange<br><br><b>ARM API to list JIT network access policies at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/jitNetworkAccessPolicies<br><br>?api-version=2020-01-01<br><b>Property:</b><br>virtualMachines/ports| <b>Scope: </b> Windows and Linux VMs; Excluding ADB VMs and ER-Connected VMs.<br><br><b>Config: </b> RestrictedPortsForWindows: 445,3389,5985 <br> RestrictedPortsForLinux: 445,3389,22<br><br> <b>Passed: </b><br>NSG is configured and no inbound port is open or NSG is configured and no restricted ports are open<br><br> <b>Failed: </b><br>No NSG is configured on VM or NSG is configured but restricted ports are open.<br><br><b>NotApplicable: </b><br>VM instance is part of ADB cluster.|
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Deploy_GuestConfig_Extension<br><br><b>DisplayName:</b><br>Guest Configuration extension must be deployed to the VM using Azure Policy assignment. <br><br><b>Description: </b><br> Guest Configuration extension must be deployed to the VM using Azure Policy assignment. | <b> ARM API to list Virtual Machines at subscription level:</b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Compute/virtualMachines<br>?api-version=2019-07-01<br><br><b>Properties:</b><br> identity.type <br> <br> <b> ARM API to list Virtual Machine Extensions at resource level: </b> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}<br>/providers/Microsoft.Compute/virtualMachines/{vmName}/extensions? <br> api-version=2019-07-01 <br><br><b>Properties:</b><br> properties.type <br> properties.publisher | <b>Scope: </b> Applies to all Azure VMs. (NA for ADB and AKS VMs)<br><br><b>Config: </b> Windows: <br> ExtensionType: ConfigurationForWindows, <br>ExtensionPublisher: Microsoft.GuestConfiguration, <br>RequiredVersion: 1.11.0 <br>Linux: <br>ExtensionType: ConfigurationForLinux, <br>ExtensionPublisher: Microsoft.GuestConfiguration, <br>RequiredVersion: 1.9.0 <br> ExclusionTags <br> Desciption: VM is part of ADB cluster., <br> TagName: vendor, <br> TagValue: Databricks <br> Desciption: VM is part of AKS cluster., <br> TagName: orchestrator, <br> TagValue: kubernetes <br><br> <b>Passed: </b><br> Guest config extension is present, and <br> System assigned MI is enabled for VM.<br><br> <b>Failed: </b><br> Guest config extension is not present in VM, or <br> System assigned MI is disabled for VM.<br><br><b>NotApplicable: </b><br>VM is part of ADB cluster. |
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Deploy_Data_Collection_Extension<br><br><b>DisplayName:</b><br>[Preview]: Network traffic data collection agent should be installed on Windows/Linux virtual machines.<br><br><b>Description:</b><br>Network traffic data collection agent should be installed on Windows/Linux virtual machines. | <b>ARM API to list Virtual Machine Extensions at resource level:</b><br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}<br>/providers/Microsoft.Compute/virtualMachines/{vmName}/extensions<br>?api-version=2019-07-01<br><br><b>Properties:</b><br>publisher, type | <b>Scope: </b> Windows VMs + Linux VMs (ADB VMs NA currently).<br><br><b>Config: </b> ExtensionType: DependencyAgentWindows<br>Publisher: Microsoft.Azure.Monitoring.DependencyAgent<br><br>ExtensionType: DependencyAgentLinux<br> Publisher: Microsoft.Azure.Monitoring.DependencyAgent<br><br> *If ASC assessment available* <br><b>Passed: </b><br>ASC assessment found with Healthy status code.<br><br> <b>Failed: </b><br>ASC assessment found with Unhealthy status code.<br><br><b>NotApplicable: </b><br>VM is part of ADB cluster. <br> *If ASC assessment not available* <br><b>Passed: </b><br> Network traffic data collection agent is present for VM. <br><br> <b>Failed: </b> <br>Network traffic data collection agent is missing for VM.<br><br><b>NotApplicable: </b><br>VM is part of ADB cluster.|
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Enable_Antimalware<br><br><b>DisplayName:</b><br>Ensure all devices have anti-malware protection installed and enabled.<br><br><b>Description:</b><br>Antimalware must be enabled with real time protection on Virtual Machine. | <b>ARM API to list Virtual Machine Extensions at resource level:</b><br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}<br>/providers/Microsoft.Compute/virtualMachines/{vmName}/extensions<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br>publisher, type, RealtimeProtectionEnabled | <b>Scope: </b> Windows VMs (Linux VMs NA currently).<br><br><b>Config: </b> ExtensionType: IaaSAntimalware <br>Publisher: Microsoft.Azure.Security <br><br> <b>Passed: </b><br>a. extension is present in VM <br> *and* <br> b. auto-upgrade-to-minor-version is enabled <br> *and* <br> c. real-time-protection is enabled.<br><br> <b>Failed: </b><br>Required Antimalware extension is missing for VM <br> *or* <br> Auto upgrade to minor version is configured as false for extension <br> *or* <br>Real time protection is disabled for extension.<br><br><b>NotApplicable: </b><br>Linux OS virtual machines.|
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Missing_OS_Patches<br><br><b>DisplayName:</b><br>Patch assets to protect against vulnerabilities.<br><br><b>Description:</b><br>Virtual Machine must have all the required OS patches installed. | <b>ARM API to list security assessments at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments?<br>api-version=2020-01-01<br><br><b>Properties:</b><br>id, name, resourceDetails/Id, displayName, status/code, status, additionalData | <b>Scope: </b> Windows and Linux VMs (ADB VMs and AKS VMs NA).<br><br><b>Config: </b>NA<br><br> <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><br> <b>Failed: </b><br>ASC assessment found with Unhealthy status code.|
| <b>ControlId:</b><br>Azure_VirtualMachine_NetSec_Apply_ASC_Network_Recommendations<br><br><b>DisplayName:</b><br>Apply Adaptive Network Hardening to your virtual machines.<br><br><b>Description:</b><br>Adaptive Network Hardening recommendations <br>should be applied on internet facing virtual machines. | <b>ARM API to list security assessments at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments?<br>api-version=2020-01-01<br><br><b>Properties:</b><br>id, name, resourceDetails/Id, displayName, status/code, status, additionalData | <b>Scope: </b> Windows and Linux VMs.<br><br><b>Config: </b> NA<br><br> <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><br> <b>Failed: </b><br>ASC assessment found with Unhealthy status code.|
